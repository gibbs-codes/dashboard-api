name: Deploy dashboard-api to Mac Mini

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  APP_NAME: dashboard-api

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure Docker environment
      run: |
        echo "Deploying ${{ github.repository }} from organization ${{ github.repository_owner }}"
        
        # Create Docker config directory
        mkdir -p ~/.docker
        
        # Create config without keychain
        cat > ~/.docker/config.json << 'EOF'
        {
          "auths": {},
          "credsStore": "",
          "credHelpers": {},
          "experimental": "disabled"
        }
        EOF
        
        # Test Docker access
        echo "Testing Docker access..."
        docker --version
        
    - name: Set up deployment directory
      run: |
        DEPLOY_DIR=~/deployments/${{ env.APP_NAME }}
        echo "Cleaning up old deployment..."
        
        # Clean up directory
        rm -rf $DEPLOY_DIR
        mkdir -p $DEPLOY_DIR
        
        echo "Copying new code..."
        cp -r $GITHUB_WORKSPACE/* $DEPLOY_DIR/
        
    - name: Copy secrets and credentials
      run: |
        DEPLOY_DIR=~/deployments/${{ env.APP_NAME }}
        APP_SECRETS=~/secrets/${{ env.APP_NAME }}
        
        echo "Copying environment file..."
        if [ -f "$APP_SECRETS/production.env" ]; then
          cp $APP_SECRETS/production.env $DEPLOY_DIR/.env
          echo "✅ Environment file copied as .env"
        else
          echo "❌ Environment file not found at $APP_SECRETS/production.env"
          exit 1
        fi
        
    - name: Build and start container
      env:
        DOCKER_CONFIG: ~/.docker
        DOCKER_BUILDKIT: 0
      run: |
        cd ~/deployments/${{ env.APP_NAME }}
        echo "Building dashboard-api for organization ${{ github.repository_owner }}..."
        
        # Stop and remove any existing container
        docker stop dashboard-api-production 2>/dev/null || true
        docker rm dashboard-api-production 2>/dev/null || true
        
        # Build the image
        docker build -t dashboard-api:${{ github.sha }} -t dashboard-api:latest .
        
        # Run the container with shared network
        docker run -d \
          --name dashboard-api-production \
          --restart unless-stopped \
          --network gibbs-apps \
          --label "app=dashboard-api" \
          -p 3002:3002 \
          --env-file .env \
          -e NODE_ENV=production \
          -e PORT=3002 \
          dashboard-api:${{ github.sha }}
        
    - name: Verify deployment
      run: |
        echo "Waiting for container to start..."
        for i in {1..10}; do
          if curl -f http://localhost:3002/health; then
            echo "✅ dashboard-api deployment successful!"
            exit 0
          fi
          echo "Health check attempt $i failed. Retrying in 5 seconds..."
          sleep 5
        done
        
        echo "❌ Health check failed after multiple attempts."
        echo "Container logs:"
        docker logs dashboard-api-production
        exit 1
        
    - name: Clean up old images
      run: |
        # Remove untagged images to clean up previous builds
        docker image prune -f
        
    - name: Show final status
      run: |
        echo "=== Final Status ==="
        docker ps | grep dashboard-api-production
        echo "dashboard-api is available at http://localhost:3002"
        